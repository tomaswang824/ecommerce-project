# 🚀 后端生产环境部署指南

## 📋 部署方案对比

| 平台 | 免费额度 | 难度 | 推荐度 |
|------|---------|------|--------|
| **Railway** | $5/月免费额度 | ⭐ 简单 | ⭐⭐⭐⭐⭐ 强烈推荐 |
| **Render** | 750小时/月 | ⭐⭐ 中等 | ⭐⭐⭐⭐ 推荐 |
| **Fly.io** | 3个免费应用 | ⭐⭐⭐ 较难 | ⭐⭐⭐ 可选 |
| **Heroku** | 收费 | ⭐⭐ 中等 | ⭐⭐ 不推荐（无免费版） |

---

## 🎯 方案 1: Railway 部署（推荐）⭐⭐⭐⭐⭐

### 为什么选择 Railway？
- ✅ 免费 $5/月额度（足够小项目使用）
- ✅ 自动检测 Node.js 项目
- ✅ 内置 MongoDB 支持
- ✅ 自动 HTTPS
- ✅ 自动部署（连接 GitHub 后）
- ✅ 简单易用的界面

---

### 步骤 1: 准备后端代码

#### 1.1 创建 Railway 配置文件

在 `backend/` 目录创建 `railway.json`：

```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "startCommand": "npm start",
    "healthcheckPath": "/api/health",
    "healthcheckTimeout": 100,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

#### 1.2 修改 `backend/package.json`

确保包含启动脚本：

```json
{
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "engines": {
    "node": ">=18.0.0"
  }
}
```

#### 1.3 添加健康检查接口

在 `backend/server.js` 添加（在其他路由之前）：

```javascript
// 健康检查接口
app.get('/api/health', (req, res) => {
  res.status(200).json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    uptime: process.uptime()
  })
})
```

#### 1.4 更新 CORS 配置

修改 `backend/server.js` 的 CORS 部分：

```javascript
const cors = require('cors')

const allowedOrigins = [
  'http://localhost:3000',
  'http://localhost:3003',
  process.env.FRONTEND_URL || 'https://your-project.vercel.app'
]

app.use(cors({
  origin: function(origin, callback) {
    // 允许没有 origin 的请求（如移动应用、Postman）
    if (!origin) return callback(null, true)

    if (allowedOrigins.indexOf(origin) !== -1 ||
        origin.endsWith('.vercel.app')) {
      callback(null, true)
    } else {
      callback(new Error('Not allowed by CORS'))
    }
  },
  credentials: true
}))
```

---

### 步骤 2: 部署到 Railway

#### 2.1 注册 Railway 账号

1. 访问：https://railway.app
2. 点击 **Start a New Project**
3. 使用 **GitHub** 账号登录（推荐）

#### 2.2 创建新项目

1. 点击 **New Project**
2. 选择 **Deploy from GitHub repo**
3. 选择 `ecommerce-project` 仓库
4. Railway 会自动检测到 Node.js 项目

#### 2.3 配置 Root Directory

**重要！** Railway 默认会尝试部署整个仓库，需要指定后端目录：

1. 项目创建后，点击项目名称
2. 点击 **Settings** 标签
3. 找到 **Root Directory**
4. 设置为：`backend`
5. 点击 **Save**

#### 2.4 添加 MongoDB 数据库

**方式 A: 使用 Railway 内置 MongoDB（推荐）**

1. 在项目页面，点击 **+ New**
2. 选择 **Database**
3. 选择 **Add MongoDB**
4. Railway 会自动创建 MongoDB 实例
5. 自动生成连接字符串并注入环境变量 `MONGO_URL`

**方式 B: 使用现有 MongoDB Atlas**

1. 点击项目名称
2. 点击 **Variables** 标签
3. 点击 **+ New Variable**
4. 添加：
   ```
   MONGODB_URI = mongodb+srv://tomaswang824_db_user:FjOq4CCXzIFTNXWC@cluster0.lttikq2.mongodb.net/ecommerce_prod?retryWrites=true&w=majority&appName=Cluster0
   ```

#### 2.5 配置环境变量

在 **Variables** 标签添加以下变量：

```bash
# 服务器配置
PORT=5000
NODE_ENV=production

# MongoDB（如果使用 Railway MongoDB，会自动设置 MONGO_URL）
# MONGODB_URI=mongodb+srv://... （如果使用 Atlas）

# JWT 密钥（重要！必须修改）
JWT_SECRET=your-super-secret-jwt-key-min-32-characters-long

# CORS 配置
FRONTEND_URL=https://your-project.vercel.app

# 可选：日志级别
LOG_LEVEL=info
```

**生成安全的 JWT_SECRET：**
```bash
# 在终端运行
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

#### 2.6 部署

1. 配置完成后，Railway 会自动开始构建和部署
2. 等待 2-3 分钟
3. 部署完成后，会显示 **Deployment successful**

#### 2.7 获取后端 URL

1. 点击 **Settings** 标签
2. 找到 **Domains** 部分
3. 点击 **Generate Domain**
4. 会生成类似：`https://your-app.up.railway.app`
5. **复制这个 URL**（稍后需要配置到 Vercel）

---

### 步骤 3: 测试后端 API

#### 3.1 测试健康检查

在浏览器访问：
```
https://your-app.up.railway.app/api/health
```

应该返回：
```json
{
  "status": "ok",
  "timestamp": "2025-10-05T...",
  "uptime": 123.45
}
```

#### 3.2 测试商品接口

```
https://your-app.up.railway.app/api/products
```

应该返回商品列表（空数组或已有数据）

---

### 步骤 4: 连接 Vercel 前端

#### 4.1 配置 Vercel 环境变量

1. 访问 Vercel Dashboard: https://vercel.com/dashboard
2. 选择你的项目
3. 点击 **Settings** → **Environment Variables**
4. 添加变量：

```bash
VITE_API_URL = https://your-app.up.railway.app
```

**注意：不要在 URL 末尾加斜杠！**

#### 4.2 重新部署 Vercel

1. 回到 **Deployments** 标签
2. 点击最新部署
3. 点击 **⋯** → **Redeploy**
4. 等待部署完成

#### 4.3 验证连接

访问你的 Vercel 网站，应该能看到商品数据了！

---

## 🎯 方案 2: Render 部署

### 步骤 1: 注册 Render

1. 访问：https://render.com
2. 使用 GitHub 账号登录

### 步骤 2: 创建 Web Service

1. 点击 **New +** → **Web Service**
2. 连接 GitHub 仓库：`ecommerce-project`
3. 配置：

```
Name: ecommerce-backend
Region: Singapore (或其他靠近用户的区域)
Branch: main
Root Directory: backend
Runtime: Node
Build Command: npm install
Start Command: npm start
```

### 步骤 3: 配置环境变量

在 **Environment** 部分添加：

```bash
PORT=5000
NODE_ENV=production
MONGODB_URI=mongodb+srv://...
JWT_SECRET=your-secret-key
FRONTEND_URL=https://your-project.vercel.app
```

### 步骤 4: 选择计划

- 选择 **Free** 计划
- 点击 **Create Web Service**

### 步骤 5: 等待部署

Render 会自动构建和部署，完成后会显示服务 URL。

---

## 🎯 方案 3: Fly.io 部署（高级）

### 步骤 1: 安装 Fly CLI

```bash
# Windows (PowerShell)
powershell -Command "iwr https://fly.io/install.ps1 -useb | iex"

# macOS/Linux
curl -L https://fly.io/install.sh | sh
```

### 步骤 2: 登录

```bash
fly auth login
```

### 步骤 3: 初始化项目

```bash
cd backend
fly launch
```

会提示：
- App name: `ecommerce-backend`
- Region: `sin` (Singapore)
- Create Postgres? `No`
- Deploy now? `No`

### 步骤 4: 配置环境变量

```bash
fly secrets set MONGODB_URI="mongodb+srv://..."
fly secrets set JWT_SECRET="your-secret-key"
fly secrets set NODE_ENV="production"
fly secrets set FRONTEND_URL="https://your-project.vercel.app"
```

### 步骤 5: 部署

```bash
fly deploy
```

---

## 📋 部署后配置清单

### ✅ 后端检查

- [ ] 健康检查接口可访问
- [ ] API 接口返回正确数据
- [ ] MongoDB 连接成功
- [ ] CORS 配置正确
- [ ] 环境变量已设置

### ✅ 前端检查

- [ ] Vercel 环境变量 `VITE_API_URL` 已设置
- [ ] 前端能成功调用后端 API
- [ ] 商品数据正常显示
- [ ] 用户注册/登录正常
- [ ] 购物车功能正常

---

## 🐛 常见问题排查

### 问题 1: 502 Bad Gateway

**原因**：后端未启动或启动失败

**解决**：
1. 查看 Railway/Render 的日志
2. 检查 `package.json` 的 `start` 脚本
3. 确认 MongoDB 连接字符串正确

### 问题 2: CORS 错误

**原因**：后端未允许前端域名

**解决**：
在后端添加 Vercel 域名到 CORS 白名单

### 问题 3: 前端显示 "加载中..." 但没有数据

**原因**：`VITE_API_URL` 配置错误

**解决**：
1. 检查 Vercel 环境变量
2. 确保 URL 不以 `/` 结尾
3. Redeploy Vercel

### 问题 4: MongoDB 连接失败

**原因**：IP 白名单限制

**解决**：
1. 登录 MongoDB Atlas
2. Network Access → Add IP Address
3. 选择 **Allow Access from Anywhere** (`0.0.0.0/0`)

---

## 🚀 自动化部署流程

配置完成后，未来的部署流程：

1. **本地修改代码**
2. **提交到 GitHub**：
   ```bash
   git add .
   git commit -m "更新功能"
   git push
   ```
3. **自动部署**：
   - Railway/Render 自动检测 GitHub 推送
   - 自动构建和部署后端
   - Vercel 自动部署前端

**完全自动化，无需手动操作！**

---

## 💡 最佳实践

1. **使用环境变量**：不要在代码中硬编码敏感信息
2. **启用 HTTPS**：所有平台都默认提供免费 HTTPS
3. **监控日志**：定期查看部署平台的日志
4. **设置告警**：配置服务异常时的邮件通知
5. **数据备份**：定期备份 MongoDB 数据

---

## 📞 需要帮助？

如果遇到问题：

1. 查看平台的部署日志
2. 检查环境变量配置
3. 测试后端健康检查接口
4. 提供错误信息，我来帮你解决

---

**现在开始部署吧！推荐使用 Railway，只需 10 分钟即可完成！** 🚀
